# RAG Ingestion Pipeline Specification

**Version:** 1.0
**Date:** 2025-04-10

## 1. Introduction & Objective

This document outlines the specification for an automated pipeline designed to ingest EPUB documents, convert them into RAG-optimized Markdown, and prepare them for inclusion in a semantic library for the "Self-Improving Mode Factory" project. The primary goal is to automate the currently manual and inefficient process of document cleaning and conversion, ensuring content fidelity and preserving structural information like the Table of Contents (ToC).

## 2. Functional Requirements

1.  **Source Acquisition (EPUB):** The pipeline *should* be able to acquire EPUB files from a source. (See Assumptions/Constraints regarding Zlibrary).
2.  **Conversion (EPUB -> HTML -> MD):** Convert EPUB content (primarily XHTML internally) into Markdown format.
3.  **Table of Contents (ToC) Preservation:** Extract the hierarchical ToC from the EPUB and include it in a clearly demarcated section within the final Markdown output.
4.  **Content Cleaning (RAG Optimization):** Remove specific artifacts from the Markdown content that are detrimental to RAG performance. This includes, but is not limited to:
    *   Empty image links: `![]()`
    *   Pandoc/Markdown header identifiers: `{#...}`
    *   Footnote definitions and reference links (e.g., `[^1]`, `[^1]: ...`)
    *   Figure references (e.g., `See Figure 1.1`) - *Initial focus on simpler patterns; complex semantic understanding is out of scope for v1.*
    *   Excessive whitespace and redundant line breaks.
5.  **Output:** Save the cleaned, RAG-optimized Markdown content, including the ToC, to a designated output directory. The output should ideally be a single Markdown file per EPUB.
6.  **Modularity & Extensibility:** The pipeline architecture should be modular to facilitate future extensions, such as adding support for PDF documents or different cleaning rules.
7.  **Agent Integration:** Provide a clear interface (e.g., a Python function) allowing agents within the factory to invoke the pipeline programmatically.

## 3. Non-Functional Requirements

*   **Efficiency:** The pipeline should process EPUBs in a reasonable timeframe.
*   **Robustness:** Handle common EPUB variations and potential errors gracefully (e.g., malformed EPUBs, missing ToC).
*   **Maintainability:** Code should be well-structured, documented, and easy to modify.
*   **Dependency Management:** Dependencies (Python libraries, external tools) should be clearly documented.

## 4. Assumptions & Constraints

1.  **Zlibrary Acquisition:** Automating downloads from Zlibrary presents significant technical, legal, and ethical challenges (CAPTCHAs, rate limits, terms of service, copyright). **Assumption (High Risk):** For v1, the pipeline might assume EPUB files are already downloaded and available locally. A separate, dedicated module/process might handle acquisition, or it may remain a manual step. This needs further investigation and decision.
2.  **Pandoc Dependency:** The conversion process relies on the external command-line tool `pandoc`. **Constraint:** `pandoc` must be installed and accessible in the environment where the pipeline runs.
3.  **EPUB Structure:** Assumes standard EPUB2/EPUB3 structure. Highly non-standard or DRM-protected EPUBs may not be processed correctly.
4.  **Cleaning Scope:** Cleaning focuses on predefined textual patterns (regex). It will not perform complex semantic analysis or image/table extraction.
5.  **Language:** Primarily designed for English language documents initially.

## 5. Recommended Libraries & Tools

1.  **`EbookLib` (Python Library):**
    *   **Justification:** Mature library for parsing EPUB2/EPUB3 files. Provides access to metadata, content items (XHTML, CSS, images), and crucially, the structured Table of Contents (NCX or NavMap).
    *   **Limitations:** Does not perform direct EPUB-to-Markdown conversion or the specific RAG cleaning required. ToC data needs explicit extraction and formatting. Relies on internal XHTML structure which is then passed to another tool for conversion.
2.  **`pandoc` (External Tool):**
    *   **Justification:** A powerful, universal document converter. Handles the core conversion from HTML (extracted from EPUB by `EbookLib`) to Markdown effectively. Supports various Markdown flavors.
    *   **Limitations:** Requires separate installation (system dependency). Default conversion does not perform the specific RAG-focused cleaning needed (removes some HTML tags but leaves artifacts like `{#...}` and doesn't handle footnote logic cleanly for RAG). Needs to be invoked via Python's `subprocess`.
3.  **Python `re` Module (Built-in):**
    *   **Justification:** Standard library module for regular expression operations. Essential for implementing the custom cleaning logic on the Markdown output generated by `pandoc`.
    *   **Limitations:** Regex complexity can grow, potentially impacting maintainability if not managed well. May not perfectly handle all edge cases in formatting variations.

## 6. High-Level Architecture

```
+-------------------+      +-----------------+      +--------------------+      +--------------------+      +--------------------+      +-----------------+
| Source EPUB Files | ---> | epub_processor  | ---> | markdown_converter | ---> | markdown_cleaner   | ---> | output_formatter   | ---> | RAG-Optimized |
| (Local/Acquired)  |      | (EbookLib)      |      | (pandoc via        |      | (Python regex)     |      | (Combine ToC &     |      | Markdown File |
|                   |      | - Parse EPUB    |      |  subprocess)       |      | - Remove artifacts |      |  cleaned content)  |      |               |
|                   |      | - Extract HTML  |      | - HTML -> MD       |      | - Normalize space  |      | - Add ToC section  |      |               |
|                   |      | - Extract ToC   |      |                    |      |                    |      |                    |      |               |
+-------------------+      +-----------------+      +--------------------+      +--------------------+      +--------------------+      +-----------------+
```

**Flow:**

1.  **Input:** Path to an EPUB file.
2.  **EPUB Processor:** Uses `EbookLib` to parse the EPUB, extract the ToC structure, and identify relevant HTML content items.
3.  **Markdown Converter:** For each HTML item, invoke `pandoc` to convert it to Markdown. Concatenate the results.
4.  **Markdown Cleaner:** Apply a series of regex substitutions to the concatenated Markdown string to remove unwanted artifacts.
5.  **Output Formatter:** Format the extracted ToC into a readable Markdown section. Prepend the ToC section to the cleaned Markdown content.
6.  **Output:** Save the final combined string to a `.rag.md` file.

## 7. Output Format

*   A single Markdown file per input EPUB, named `[original_filename].rag.md`.
*   File begins with a clearly demarcated ToC section.
*   Main content follows, cleaned according to RAG optimization rules.
*   UTF-8 encoding.

**Example Structure:**

```markdown
# Table of Contents

*   [Chapter 1: Title](#chapter-1-title)
    *   [Section 1.1: Subtitle](#section-1-1-subtitle)
*   [Chapter 2: Another Title](#chapter-2-another-title)

---

# Chapter 1: Title
<a id="chapter-1-title"></a>

Cleaned Markdown content for chapter 1...

## Section 1.1: Subtitle
<a id="section-1-1-subtitle"></a>

Cleaned Markdown content for section 1.1...

# Chapter 2: Another Title
<a id="chapter-2-another-title"></a>

Cleaned Markdown content for chapter 2...
```
*(Note: Anchor generation (`<a id="...">`) might be needed if pandoc/EbookLib doesn't provide suitable ones automatically)*

## 8. Agent Integration Interface

A Python function signature like the following should be provided:

```python
def process_epub_to_rag_markdown(epub_path: str, output_dir: str) -> str:
  """
  Processes a single EPUB file for RAG ingestion.

  Args:
    epub_path: Path to the input EPUB file.
    output_dir: Directory to save the resulting .rag.md file.

  Returns:
    Path to the generated Markdown file.

  Raises:
    FileNotFoundError: If epub_path does not exist.
    PandocNotFoundError: If pandoc command is not found.
    EpubProcessingError: For errors during EPUB parsing or processing.
  """
  # Implementation using the pipeline modules
  pass
```

## 9. Future Extensions

*   **PDF Support:** Add a parallel processing path using PDF parsing libraries (e.g., `PyMuPDF`, `pdfminer.six`) and potentially different conversion/cleaning logic.
*   **Acquisition Module:** Develop a robust and compliant module for acquiring source documents (if feasible).
*   **Advanced Cleaning:** Incorporate more sophisticated NLP techniques for semantic cleaning (e.g., identifying and removing irrelevant boilerplate text).
*   **Configuration:** Allow cleaning rules and other parameters to be configured externally.
*   **Error Reporting:** Implement detailed logging and error reporting.
*   **Chunking Strategy:** Integrate intelligent chunking of the final Markdown for better RAG performance, potentially based on ToC structure.